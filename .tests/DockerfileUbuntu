FROM ubuntu:bionic as base
# ENV LC_ALL=C.UTF-8
# ENV LANG=C.UTF-8
WORKDIR /tmp
RUN curl -sL https://deb.nodesource.com/setup_13.x | bash - \
    && curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \
    && apt-get update \
    && apt-get install -y git curl net-tools python3 python3-pip python3-venv redis-server nodejs yarn \
    && curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python3 \
    && git clone --single-branch --branch v1.0.0 --depth 1 https://github.com/checktheroads/hyperglass \
    && ln -s $(which python3) /usr/bin/python \
    && echo "Python Version: $(python --version)" \
    && echo "NodeJS Version: $(node --version)" \
    && echo "Yarn Version: $(yarn --version)"
ENV PATH=$PATH:$HOME/.poetry/bin

FROM base
WORKDIR $HOME
RUN bash -c 'BASH_ENV=/etc/profile exec bash' \
    && $HOME/.poetry/bin/poetry install --no-ansi \
    && $HOME/.poetry/bin/poetry run hyperglass setup -d
    && $HOME/.poetry/bin/poetry run hyperglass build-ui
EXPOSE 8001
CMD poetry run hyperglass start
